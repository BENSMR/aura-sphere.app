# Invoice PDF Generation Guide

## Overview

Professional PDF generation and printing system for invoices with multiple export options.

**Packages:**
- `pdf` 3.11.3 - Generate PDF documents
- `printing` 5.14.2 - Print/share PDFs
- `path_provider` 2.1.5 - File system access

---

## Architecture

### 1. **InvoicePdfService** - PDF Generation
- **File**: `/lib/services/pdf/invoice_pdf_service.dart`
- **Purpose**: Generate professional invoice PDFs
- **Key Method**: `generate(InvoiceModel)` → Returns `pw.Document`

**Features:**
- Professional header with branding
- Client information section
- Line items table with calculations
- Tax and totals section
- Status badge with color coding
- Footer with notes
- Responsive design

**Status Colors:**
```dart
draft    → Gray (#6b7280)
sent     → Amber (#f59e0b)
paid     → Green (#10b981)
overdue  → Red (#ef4444)
cancelled→ Purple (#8b5cf6)
```

### 2. **InvoicePdfHandler** - PDF Operations
- **File**: `/lib/services/pdf/invoice_pdf_handler.dart`
- **Purpose**: Handle printing, sharing, and file operations

**Methods:**
```dart
// Print to device printer
printInvoice(InvoiceModel invoice)

// Share via email/messaging
shareInvoice(InvoiceModel invoice)

// Save to device storage (/Documents/invoices)
saveToFile(InvoiceModel invoice) → String filePath

// List all saved invoices
getSavedInvoices() → List<File>

// Delete saved invoice
deleteSavedInvoice(String filePath)

// Get file size in MB
getFileSizeInMB(String filePath) → double
```

### 3. **Usage Examples** - UI Components
- **File**: `/lib/services/pdf/invoice_pdf_examples.dart`
- **Ready-to-use widgets:**
  - `PrintInvoiceButton`
  - `ShareInvoiceButton`
  - `SaveInvoiceButton`
  - `InvoiceDetailWithPdf` (full screen)
  - `SavedInvoicesList` (list view)
  - `InvoiceActionMenu` (popup menu)

---

## Implementation

### Step 1: Generate and Print

```dart
import 'package:your_app/services/pdf/invoice_pdf_handler.dart';

// Simple print
await InvoicePdfHandler.printInvoice(invoice);
```

### Step 2: Share Invoice

```dart
// Share via email, messaging, etc.
await InvoicePdfHandler.shareInvoice(invoice);
```

### Step 3: Save to Device

```dart
// Save to Documents/invoices/
final filePath = await InvoicePdfHandler.saveToFile(invoice);
// Result: /data/user/0/com.app/documents/invoices/INV-2024-001.pdf
```

### Step 4: Display Saved Invoices

```dart
// Get all saved invoice PDFs
final files = await InvoicePdfHandler.getSavedInvoices();
for (var file in files) {
  print('${file.path} - ${file.statSync().size} bytes');
}
```

---

## Usage Examples

### Example 1: Simple Print Button

```dart
PrintInvoiceButton(invoice: invoice)
```

**Features:**
- Loading state with spinner
- Error handling
- Success toast notification
- One-liner integration

### Example 2: Share Invoice

```dart
ShareInvoiceButton(invoice: invoice)
```

**Opens system share sheet for:**
- Email
- Messaging apps
- Cloud storage
- Other apps

### Example 3: Save to Device

```dart
SaveInvoiceButton(invoice: invoice)
```

**Saves to:**
```
/Documents/invoices/INV-2024-001.pdf
```

### Example 4: Full Invoice Detail Screen

```dart
InvoiceDetailWithPdf(invoice: invoice)
```

**Includes:**
- Invoice details card
- Print button
- Share button
- Save button
- All with error handling

### Example 5: Saved Invoices List

```dart
SavedInvoicesList()
```

**Features:**
- Lists all saved PDFs
- Shows file size
- Delete button
- Real-time refresh
- Empty state handling

### Example 6: Popup Menu

```dart
InvoiceActionMenu(
  invoice: invoice,
  onPrint: () => InvoicePdfHandler.printInvoice(invoice),
  onShare: () => InvoicePdfHandler.shareInvoice(invoice),
  onSave: () => InvoicePdfHandler.saveToFile(invoice),
)
```

---

## PDF Layout

### Header
```
AURASPHERE PRO              Invoice
Professional Invoice         INV-2024-001
```

### Client Section
```
Bill To:                      Invoice Date: Nov 27, 2024
Acme Corp                     Due Date: Dec 27, 2024
acme@example.com              Paid Date: —
Client ID: cid_123            STATUS: PAID (green badge)
```

### Items Table
```
Description    | Qty | Unit Price | Total
Web Dev        | 40  | $150       | $6,000.00
UI Design      | 20  | $100       | $2,000.00
```

### Totals
```
Subtotal: USD 8,000.00
Tax (20%): USD 1,600.00
─────────────────────────
TOTAL: USD 9,600.00
```

### Footer
```
Notes:
Thank you for your business! Please remit payment by the due date.

Generated by AuraSphere Pro
```

---

## Integration Steps

### Step 1: Add to Invoice Detail Screen

```dart
class InvoiceDetailScreen extends StatelessWidget {
  final InvoiceModel invoice;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Invoice ${invoice.invoiceNumber}'),
        actions: [
          IconButton(
            icon: Icon(Icons.more_vert),
            onPressed: () => _showPdfMenu(context),
          ),
        ],
      ),
      body: Column(
        children: [
          // Invoice details...
          SizedBox(height: 24),
          Wrap(
            spacing: 12,
            children: [
              PrintInvoiceButton(invoice: invoice),
              ShareInvoiceButton(invoice: invoice),
              SaveInvoiceButton(invoice: invoice),
            ],
          ),
        ],
      ),
    );
  }

  void _showPdfMenu(BuildContext context) {
    showModalBottomSheet(
      context: context,
      builder: (_) => Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          ListTile(
            leading: Icon(Icons.print),
            title: Text('Print'),
            onTap: () => InvoicePdfHandler.printInvoice(invoice),
          ),
          ListTile(
            leading: Icon(Icons.share),
            title: Text('Share'),
            onTap: () => InvoicePdfHandler.shareInvoice(invoice),
          ),
          ListTile(
            leading: Icon(Icons.download),
            title: Text('Save'),
            onTap: () => InvoicePdfHandler.saveToFile(invoice),
          ),
        ],
      ),
    );
  }
}
```

### Step 2: Add Saved Invoices Screen

```dart
class InvoicesArchiveScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Archived Invoices')),
      body: SavedInvoicesList(),
    );
  }
}
```

### Step 3: Error Handling

All methods throw `InvoicePdfException` on failure:

```dart
try {
  await InvoicePdfHandler.printInvoice(invoice);
} on InvoicePdfException catch (e) {
  print('PDF Error: ${e.message}');
  // Show error to user
}
```

---

## File Storage

### Location
```
/data/user/0/com.company.app/documents/invoices/
```

### File Naming
```
INV-2024-001.pdf    (if invoiceNumber set)
1234567890.pdf      (timestamp fallback)
```

### List Saved Files

```dart
final files = await InvoicePdfHandler.getSavedInvoices();

for (var file in files) {
  final fileName = file.path.split('/').last;
  final sizeInMB = await InvoicePdfHandler.getFileSizeInMB(file.path);
  print('$fileName - ${sizeInMB.toStringAsFixed(2)} MB');
}
```

---

## Permissions (Android/iOS)

### Android
Add to `android/app/src/main/AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
```

### iOS
Add to `ios/Runner/Info.plist`:
```xml
<key>NSLocalNetworkUsageDescription</key>
<string>App needs to print invoices</string>
<key>NSBonjourServiceTypes</key>
<array>
  <string>_airprint._tcp</string>
</array>
```

---

## Customization

### Change Logo/Branding

Edit `_buildHeader()` in `InvoicePdfService`:

```dart
static pw.Widget _buildHeader(InvoiceModel invoice) {
  return pw.Text(
    'YOUR COMPANY NAME',  // ← Change this
    style: pw.TextStyle(
      fontSize: 28,
      fontWeight: pw.FontWeight.bold,
      color: PdfColor.fromHex('#YOUR_COLOR'),  // ← Change color
    ),
  );
}
```

### Change Status Colors

Edit `_getStatusColor()`:

```dart
static PdfColor _getStatusColor(String status) {
  switch (status.toLowerCase()) {
    case 'draft':
      return PdfColor.fromHex('#YOUR_COLOR');
    // ... rest
  }
}
```

### Change Fonts

Edit `pageTheme`:

```dart
pageTheme: pw.PageTheme(
  theme: pw.ThemeData.withFont(
    base: pw.Font.times(),        // ← Different font
    bold: pw.Font.timesBold(),
  ),
),
```

### Add Company Footer

Add to `_buildFooter()`:

```dart
pw.Text(
  'AuraSphere Pro\n123 Business St\nNew York, NY 10001\n+1 (555) 123-4567',
  textAlign: pw.TextAlign.center,
  style: pw.TextStyle(fontSize: 10),
)
```

---

## Testing Checklist

- ✅ Generate PDF from invoice
- ✅ Print to device printer
- ✅ Share via system share sheet
- ✅ Save to Documents/invoices/
- ✅ List saved invoices
- ✅ Delete saved invoice
- ✅ Get file size
- ✅ Error handling (invalid invoice, permissions)
- ✅ Different invoice statuses (draft/sent/paid/overdue)
- ✅ Multi-item invoices
- ✅ Large totals (currency formatting)
- ✅ Special characters in client name/email

---

## Cloud Function Integration (Optional)

Generate PDFs server-side and store in Cloud Storage:

```typescript
// functions/src/finance/generateInvoicePdf.ts
export const generateInvoicePdf = functions.https.onCall(
  async (data: {invoice: InvoiceModel}, context) => {
    const {invoice} = data;
    
    // Generate PDF with pdf-lib or similar
    // Store in Cloud Storage: gs://bucket/invoices/{invoiceId}.pdf
    // Return download URL
    
    return {
      success: true,
      downloadUrl: 'https://...',
    };
  }
);
```

---

## Performance Notes

- PDFs generated in-memory (no temp files)
- File saving is async (don't block UI)
- Large invoices (100+ items) may take 1-2 seconds
- Printing requires user interaction (system dialog)
- Sharing is instant (uses platform intent)

---

## Related Files

- `/lib/models/invoice_model.dart` - Invoice data model
- `/lib/services/invoice_service.dart` - Invoice CRUD
- `/lib/providers/invoice_provider.dart` - State management
- `/docs/invoice_cloud_functions_guide.md` - Server-side generation
