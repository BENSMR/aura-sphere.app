# AuraSphere Pro - End-to-End Testing Guide

## Test Scenario: Generate CRM Insights â†’ Auto-Create Tasks â†’ View in Tasks Screen

### Prerequisites
- âœ… Cloud Functions deployed (just completed)
- âœ… Firebase configured with `openai.key` set
- âœ… Emulators running (optional for local testing)
- âœ… App running on device/emulator

---

## Step 1: Launch App & Navigate to CRM

1. **Run the app:**
   ```bash
   flutter run
   ```

2. **Login** with test user credentials
   - Email: test@aurasphere.dev
   - Password: TestPassword123!

3. **Navigate to CRM screen:**
   - Tap "CRM" card from dashboard
   - Or use: `Navigator.pushNamed(context, AppRoutes.crm)`

---

## Step 2: Generate CRM Insights

### From CRM Screen:
1. **Ensure contacts are loaded** (contacts should appear in list)
2. **Select 2-3 contacts** by tapping them
3. **Tap "Generate Insights"** button
   - This calls `generateCrmInsights` Cloud Function
   - Sends: `{ userId, contactIds: [...], contacts: [...] }`

### Expected Behavior:

**Loading State (0-10s):**
- Loading spinner appears
- "Generating insights with AI..." message
- Button disabled

**Success (API responds):**
- Insights display with actions like:
  - "Email John about Q4 proposal"
  - "Schedule call with Jane"
  - "Send contract to Bob"
- Each action has: `title`, `suggestion`, `channel`, `dueDays`

**Cache Hit (within 3 hours):**
- Message: "Using cached insights (generated X minutes ago)"
- Same insights instantly

---

## Step 3: Verify Tasks Created in Firestore

### Check 1: Direct Firestore Read

```bash
# Via Firebase Console:
# Project: aurasphere-pro
# Collection: users/{uid}/tasks
# Filter: autoGenerated == true
```

**Expected documents:**
```json
{
  "id": "task_abc123",
  "userId": "{user-uid}",
  "title": "Email John about Q4 proposal",
  "description": "Email John about Q4 proposal",
  "channel": "email",
  "status": "pending",
  "autoGenerated": true,
  "sourceInsightId": "insight_xyz789",
  "createdAt": "2025-11-26T14:30:00Z",
  "dueAt": "2025-11-28T14:30:00Z",
  "remindAt": "2025-11-28T14:30:00Z",
  "assignedTo": "{user-uid}"
}
```

### Check 2: Flutter App - Tasks Screen

1. **Navigate to Tasks:**
   - Tap "Tasks" card in dashboard (if visible)
   - Or use: `Navigator.pushNamed(context, AppRoutes.tasks)`

2. **Verify display:**
   ```
   âœ… TasksListScreen loads
   âœ… Auto-generated tasks appear in list
   âœ… Each task shows:
      - Title: "Email John about Q4 proposal"
      - Channel: ðŸ“§ email icon
      - Status: pending (gray color)
      - Due date: Nov 28
   ```

3. **Verify data flow:**
   - TaskProvider.loadTasks() queries Firestore
   - Filters: `where('status', '==', 'pending')`
   - Displays with: `context.watch<TaskProvider>()`

---

## Step 4: Verify Task Reminder Processing

### Scheduled Function: `processDueReminders`

**Schedule:** Every 5 minutes (Pub/Sub trigger)

**What it does:**
1. Queries all tasks with `remindAt <= now()`
2. Marks them as `status: "ready_to_send"`
3. Creates entry in `task_queue` collection

**To test manually:**

```bash
# Trigger the function directly (requires admin access):
firebase functions:call processDueReminders

# Or curl the function URL:
curl -X POST https://us-central1-aurasphere-pro.cloudfunctions.net/processDueReminders \
  -H "Content-Type: application/json" \
  -d '{"data": {}}'
```

**Check results:**
```
Collection: task_queue
Expected entry:
{
  "taskId": "task_abc123",
  "userId": "{user-uid}",
  "status": "ready_to_send",
  "createdAt": "2025-11-26T14:35:00Z",
  "deliveryAttempts": 0,
  "nextRetryAt": null
}
```

---

## Step 5: Verify UI Updates

### Test 1: Auto-refresh Tasks List

1. **Open Tasks screen**
2. **Set a task's dueAt to now() or past:**
   ```bash
   # Using Firebase Console:
   # Edit task â†’ dueAt = current timestamp
   ```
3. **Wait 5 minutes (or trigger processDueReminders manually)**
4. **Refresh Tasks screen:**
   - Pull-to-refresh or re-open screen
   - Status should still be "pending" (UI shows from Firestore)
   - Check task_queue for "ready_to_send" status

### Test 2: Task Status Updates

1. **Create task with dueAt = now + 1 minute**
2. **Wait for processDueReminders to run**
3. **Firestore shows:**
   - Task status: still "pending" (user doesn't see "ready_to_send")
   - Task_queue has "ready_to_send" entry
   - This separation allows delivery workers to process independently

---

## Step 6: Verify Data in Firestore

### Collection Structure:

```
aurasphere-pro (project)
â”œâ”€â”€ users/{uid}
â”‚   â”œâ”€â”€ crm/contacts/{contactId} âœ…
â”‚   â”œâ”€â”€ crm_insights/{insightId} âœ…
â”‚   â”‚   â””â”€â”€ raw: { actions: [...] }
â”‚   â”œâ”€â”€ crm_insights_meta/lastRun âœ…
â”‚   â”‚   â””â”€â”€ lastAt, cachedInsights
â”‚   â””â”€â”€ tasks/{taskId} âœ…
â”‚       â”œâ”€â”€ id, userId, title, description
â”‚       â”œâ”€â”€ channel, status, autoGenerated
â”‚       â”œâ”€â”€ createdAt, dueAt, remindAt
â”‚       â””â”€â”€ assignedTo, sourceInsightId
â”‚
â””â”€â”€ task_queue/{queueId}
    â”œâ”€â”€ taskId, userId, status
    â”œâ”€â”€ createdAt, deliveryAttempts
    â””â”€â”€ nextRetryAt
```

---

## Troubleshooting

### Issue 1: "Generate Insights" button disabled

**Symptom:** Button greyed out, can't click

**Checks:**
1. At least 1 contact selected?
   ```dart
   if (_selectedContactIds.isEmpty) return;
   ```

2. CRM Provider ready?
   ```bash
   firebase functions:log | grep generateCrmInsights
   ```

### Issue 2: Insights show but NO tasks created

**Symptom:** Insights display, but tasks not in Firestore

**Root cause:** One of:
1. OpenAI key not set
   ```bash
   firebase functions:config:get | grep openai
   firebase functions:config:set openai.key="sk-..."
   ```

2. Tasks write failed (check logs)
   ```bash
   firebase functions:log | grep "Failed creating"
   ```

3. Firestore rules reject write
   - Verify rule: `allow write: if request.auth.uid == userId;`
   - Each task has `userId` field set

**Fix:** Check function logs
```bash
firebase functions:log --limit 50
```

### Issue 3: Tasks don't appear in TasksListScreen

**Symptom:** Tasks in Firestore, but list empty

**Checks:**
1. TaskProvider loading?
   ```dart
   Future<void> loadTasks() async {
     _isLoading = true;
     notifyListeners();
     // ...queries Firestore
   }
   ```

2. Provider registered in app.dart?
   ```bash
   grep -n "TaskProvider" lib/app/app.dart
   ```

3. Tasks screen using provider?
   ```bash
   grep -n "context.watch<TaskProvider>" lib/screens/tasks/tasks_list_screen.dart
   ```

### Issue 4: Reminders not processing

**Symptom:** Task due, but status not updating

**Check:**
1. Pub/Sub scheduler running?
   ```bash
   firebase functions:log | grep processDueReminders
   ```

2. Query finding tasks?
   ```bash
   # Task must have:
   # - status: "pending"
   # - remindAt: <= current time
   ```

3. Firestore allows write?
   - Verify security rule for `task_queue` collection

---

## Success Criteria âœ…

| Step | Expected Result | Verify |
|------|-----------------|--------|
| 1. Select contacts & Generate | Loading â†’ Insights appear | 10-30 seconds |
| 2. Check Firestore | Tasks created with userId | Firebase Console |
| 3. Open Tasks screen | Tasks appear in list | App shows list |
| 4. Wait 5 min | processDueReminders runs | Check task_queue |
| 5. Check task_queue | Entries with ready_to_send | Firebase Console |
| 6. Refresh Tasks | Still shows pending status | App still responsive |

---

## Firebase Console Shortcuts

```
Project: https://console.firebase.google.com/project/aurasphere-pro

Collections to monitor:
- users/{uid}/crm_insights â†’ Raw AI responses
- users/{uid}/tasks â†’ User tasks (auto-generated flag)
- task_queue â†’ Delivery queue (for reminders worker)

Logs:
- Functions: firebase functions:log --limit 100
- Firestore: Rules violations in console
- Storage: Receipt uploads in console

Config:
- OpenAI key: firebase functions:config:get
- Set key: firebase functions:config:set openai.key="sk-..."
```

---

## Next Steps After Testing

If all tests pass âœ…:
1. **Production Deployment:** `firebase deploy --only functions`
2. **Enable Feature:** Set `AI_FEATURES_ENABLED = true` in feature_constants.dart
3. **Monitor:** Check `firebase functions:log` daily for errors
4. **Scale:** Increase `processDueReminders` frequency if needed (currently 5 min)

If tests fail âŒ:
1. Check `firebase functions:log` for detailed error messages
2. Verify OpenAI API key is set and valid
3. Check Firestore security rules allow writes from functions
4. Verify all required fields (userId, etc.) are present in documents
