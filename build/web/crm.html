<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aurasphere CRM Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --black: #05050f;
      --white: #ffffff;
      --light-gray: #a0a0c0;
      --accent: #00e0ff;
      --gold: #ffd700;
      --green: #00ffaa;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--black);
      color: var(--light-gray);
      font-family: 'Inter', system-ui, sans-serif;
    }
    .app-container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: rgba(10,10,20,0.8);
      border-right: 1px solid rgba(0,224,255,0.1);
      padding: 2rem 1.5rem;
      overflow-y: auto;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 2rem;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--white);
    }
    .nav-section {
      margin-bottom: 2rem;
    }
    .nav-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 0.75rem;
      letter-spacing: 1px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      color: var(--light-gray);
      text-decoration: none;
      transition: all 0.3s;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }
    .nav-item:hover, .nav-item.active {
      background: rgba(0,224,255,0.1);
      color: var(--accent);
      border-left: 3px solid var(--accent);
      padding-left: calc(1rem - 3px);
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .top-bar {
      background: rgba(10,10,20,0.6);
      border-bottom: 1px solid rgba(0,224,255,0.1);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-menu {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .user-badge {
      background: rgba(0,224,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--accent);
    }
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .page-title {
      font-size: 2rem;
      color: var(--white);
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--gold));
      color: var(--black);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,224,255,0.3);
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background: rgba(12,12,28,0.5);
      border: 1px solid rgba(0,224,255,0.15);
      border-radius: 12px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--white);
      margin-bottom: 1rem;
    }
    .card-value {
      font-size: 1.8rem;
      color: var(--accent);
      font-weight: 700;
    }
    .list-item {
      padding: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-pending {
      background: rgba(255,170,0,0.2);
      color: #ffaa00;
    }
    .status-paid {
      background: rgba(0,255,170,0.2);
      color: var(--green);
    }
    .status-overdue {
      background: rgba(255,85,136,0.2);
      color: #ff5588;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(5,5,15,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: rgba(12,12,28,0.95);
      border: 1px solid rgba(0,224,255,0.2);
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
    }
    .modal-close {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: var(--accent);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--white);
      font-weight: 600;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(0,224,255,0.2);
      border-radius: 8px;
      color: var(--white);
      font-size: 0.95rem;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    .ai-chat {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 350px;
      height: 500px;
      background: rgba(12,12,28,0.95);
      border: 1px solid rgba(0,224,255,0.2);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      z-index: 999;
      box-shadow: 0 8px 32px rgba(0,224,255,0.1);
    }
    .chat-header {
      background: linear-gradient(135deg, var(--accent), var(--gold));
      color: var(--black);
      padding: 1rem;
      border-radius: 16px 16px 0 0;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-close {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .chat-message {
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      max-width: 90%;
    }
    .message-user {
      background: rgba(0,224,255,0.2);
      color: var(--accent);
      align-self: flex-end;
    }
    .message-ai {
      background: rgba(0,255,170,0.1);
      color: var(--green);
      align-self: flex-start;
    }
    .chat-input {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      border-top: 1px solid rgba(0,224,255,0.1);
    }
    .chat-input input {
      flex: 1;
      padding: 0.5rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(0,224,255,0.2);
      border-radius: 6px;
      color: var(--white);
      font-size: 0.85rem;
    }
    .chat-input button {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: var(--black);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .alert-success {
      background: rgba(0,255,170,0.1);
      border: 1px solid rgba(0,255,170,0.3);
      color: var(--green);
    }
    .alert-error {
      background: rgba(255,85,136,0.1);
      border: 1px solid rgba(255,85,136,0.3);
      color: #ff5588;
    }
    .loading {
      display: inline-block;
      color: var(--accent);
    }
    @media (max-width: 1024px) {
      .sidebar { width: 200px; }
      .content-area { padding: 1rem; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="app-container">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo">â—‰ AURA CRM</div>
    
    <div class="nav-section">
      <div class="nav-label">Main</div>
      <div class="nav-item active" onclick="switchSection('dashboard')">
        <i class="fas fa-chart-line"></i> Dashboard
      </div>
      <div class="nav-item" onclick="switchSection('contacts')">
        <i class="fas fa-users"></i> Contacts
      </div>
      <div class="nav-item" onclick="switchSection('invoices')">
        <i class="fas fa-file-invoice-dollar"></i> Invoices
      </div>
      <div class="nav-item" onclick="switchSection('expenses')">
        <i class="fas fa-receipt"></i> Expenses
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Manage</div>
      <div class="nav-item" onclick="switchSection('inventory')">
        <i class="fas fa-boxes"></i> Inventory
      </div>
      <div class="nav-item" onclick="switchSection('tasks')">
        <i class="fas fa-tasks"></i> Tasks
      </div>
      <div class="nav-item" onclick="switchSection('ai-insights')">
        <i class="fas fa-brain"></i> AI Insights
      </div>
    </d>

    <div class="nav-section">
      <div class="nav-label">Account</div>
      <div class="nav-item" onclick="switchSection('settings')">
        <i class="fas fa-cog"></i> Settings
      </div>
      <div class="nav-item" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <!-- TOP BAR -->
    <div class="top-bar">
      <h2 id="current-page">Dashboard</h2>
      <div class="user-menu">
        <div class="user-badge" id="user-display">Loading...</div>
      </div>
    </div>

    <!-- CONTENT AREA -->
    <div class="content-area">

      <!-- DASHBOARD SECTION -->
      <section id="dashboard" class="section active">
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <button class="btn btn-primary" onclick="loadDashboardData()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>

        <div class="grid">
          <div class="card">
            <div class="card-title">Total Revenue</div>
            <div class="card-value" id="total-revenue"><span class="loading"><i class="fas fa-spinner fa-spin"></i></span></div>
          </div>
          <div class="card">
            <div class="card-title">Outstanding Invoices</div>
            <div class="card-value" id="pending-invoices"><span class="loading"><i class="fas fa-spinner fa-spin"></i></span></div>
          </div>
          <div class="card">
            <div class="card-title">Total Contacts</div>
            <div class="card-value" id="total-contacts"><span class="loading"><i class="fas fa-spinner fa-spin"></i></span></div>
          </div>
          <div class="card">
            <div class="card-title">Total Expenses</div>
            <div class="card-value" id="total-expenses"><span class="loading"><i class="fas fa-spinner fa-spin"></i></span></div>
          </div>
        </div>

        <div class="card" style="margin-bottom: 2rem;">
          <div class="card-title">Recent Activity</div>
          <div id="recent-activity">
            <div style="color: #888; text-align: center; padding: 2rem;">
              <i class="fas fa-inbox"></i> No recent activity yet
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">AI Business Insights</div>
          <div id="ai-insights-card" style="color: #a0a0c0; line-height: 1.6;">Loading AI insights...</div>
        </div>
      </section>

      <!-- CONTACTS SECTION -->
      <section id="contacts" class="section">
        <div class="page-header">
          <h1 class="page-title">Contacts</h1>
          <button class="btn btn-primary" onclick="openAddContactModal()">
            <i class="fas fa-plus"></i> New Contact
          </button>
        </div>
        <div class="card">
          <div id="contacts-list" style="color: #888; text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin"></i> Loading contacts...
          </div>
        </div>
      </section>

      <!-- INVOICES SECTION -->
      <section id="invoices" class="section">
        <div class="page-header">
          <h1 class="page-title">Invoices</h1>
          <button class="btn btn-primary" onclick="openAddInvoiceModal()">
            <i class="fas fa-plus"></i> New Invoice
          </button>
        </div>
        <div class="card">
          <div id="invoices-list" style="color: #888; text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin"></i> Loading invoices...
          </div>
        </div>
      </section>

      <!-- EXPENSES SECTION -->
      <section id="expenses" class="section">
        <div class="page-header">
          <h1 class="page-title">Expenses</h1>
          <button class="btn btn-primary" onclick="openAddExpenseModal()">
            <i class="fas fa-plus"></i> New Expense
          </button>
        </div>
        <div class="card">
          <div id="expenses-list" style="color: #888; text-align: center; padding: 2rem;">
            No expenses recorded yet
          </div>
        </div>
      </section>

      <!-- INVENTORY SECTION -->
      <section id="inventory" class="section">
        <div class="page-header">
          <h1 class="page-title">Inventory</h1>
          <button class="btn btn-primary" onclick="openAddInventoryModal()">
            <i class="fas fa-plus"></i> New Item
          </button>
        </div>
        <div class="card">
          <div id="inventory-list" style="color: #888; text-align: center; padding: 2rem;">
            No inventory items yet
          </div>
        </div>
      </section>

      <!-- TASKS SECTION -->
      <section id="tasks" class="section">
        <div class="page-header">
          <h1 class="page-title">Tasks</h1>
          <button class="btn btn-primary" onclick="openAddTaskModal()">
            <i class="fas fa-plus"></i> New Task
          </button>
        </div>
        <div class="card">
          <div id="tasks-list" style="color: #888; text-align: center; padding: 2rem;">
            No tasks yet
          </div>
        </div>
      </section>

      <!-- AI INSIGHTS SECTION -->
      <section id="ai-insights" class="section">
        <div class="page-header">
          <h1 class="page-title">AI Intelligence Center</h1>
        </div>
        <div class="card">
          <div class="card-title">Business Health Analysis</div>
          <div id="ai-health" style="color: #a0a0c0; line-height: 1.6;">Loading AI analysis...</div>
        </div>
        <div class="card" style="margin-top: 1.5rem;">
          <div class="card-title">Actionable Recommendations</div>
          <div id="ai-actions" style="color: #a0a0c0; line-height: 1.6;"></div>
        </div>
      </section>

      <!-- SETTINGS SECTION -->
      <section id="settings" class="section">
        <div class="page-header">
          <h1 class="page-title">Settings</h1>
        </div>
        <div class="card">
          <div class="card-title">Account Information</div>
          <div style="padding: 1rem;">
            <p><strong>Email:</strong> <span id="settings-email">-</span></p>
            <p style="margin-top: 1rem;"><strong>Name:</strong> <span id="settings-name">-</span></p>
            <p style="margin-top: 1rem;"><strong>Company:</strong> <span id="settings-company">-</span></p>
            <p style="margin-top: 1rem;"><strong>Subscription:</strong> <span id="settings-sub" style="background: rgba(0,255,170,0.1); padding: 0.2rem 0.5rem; border-radius: 4px;">FREE</span></p>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- MODALS -->
<div id="add-contact-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('add-contact-modal')">&times;</button>
    <h2>Add New Contact</h2>
    <div class="form-group">
      <label>Name *</label>
      <input type="text" id="contact-name" placeholder="John Doe">
    </div>
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="contact-email" placeholder="john@example.com">
    </div>
    <div class="form-group">
      <label>Phone</label>
      <input type="tel" id="contact-phone" placeholder="+1 (555) 000-0000">
    </div>
    <div class="form-group">
      <label>Company</label>
      <input type="text" id="contact-company" placeholder="Company Name">
    </div>
    <button class="btn btn-primary" onclick="saveContact()" style="width: 100%;">Save Contact</button>
  </div>
</div>

<div id="add-invoice-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('add-invoice-modal')">&times;</button>
    <h2>Create New Invoice</h2>
    <div class="form-group">
      <label>Contact Email *</label>
      <input type="email" id="invoice-contact-email" placeholder="client@example.com">
    </div>
    <div class="form-group">
      <label>Amount *</label>
      <input type="number" id="invoice-amount" placeholder="1000.00" step="0.01">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="invoice-description" placeholder="Invoice details..."></textarea>
    </div>
    <div class="form-group">
      <label>Due Date</label>
      <input type="date" id="invoice-due-date">
    </div>
    <button class="btn btn-primary" onclick="saveInvoice()" style="width: 100%;">Create Invoice</button>
  </div>
</div>

<!-- AI CHAT WIDGET -->
<div class="ai-chat" id="ai-chat-widget">
  <div class="chat-header">
    <span><i class="fas fa-robot"></i> AI Assistant</span>
    <button class="chat-close" onclick="closeAIChat()">âœ•</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-message message-ai">Hi! I'm your AI assistant. Ask me about your business, finances, or get recommendations.</div>
  </div>
  <div class="chat-input">
    <input type="text" id="chat-input" placeholder="Ask me anything..." onkeypress="handleChatKeypress(event)">
    <button onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBz0Oj1FVrXS7rVxZKH5VmPZvY0nYf3UqU",
    authDomain: "aurasphere-pro.firebaseapp.com",
    projectId: "aurasphere-pro",
    storageBucket: "aurasphere-pro.firebasestorage.app",
    messagingSenderId: "876321378652",
    appId: "1:876321378652:web:4da828bbf22c3dbac93199"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const functions = firebase.functions();

  // User data
  let currentUser = null;

  // Initialize
  window.addEventListener('load', async () => {
    checkAuth();
    await loadUserData();
    await loadDashboardData();
  });

  function checkAuth() {
    const isLoggedIn = localStorage.getItem('user_logged_in');
    if (!isLoggedIn) {
      window.location.href = '/crm-login.html';
    }
  }

  async function loadUserData() {
    const email = localStorage.getItem('user_email');
    const name = localStorage.getItem('user_name');
    const company = localStorage.getItem('user_company');
    const subscription = localStorage.getItem('user_subscription') || 'free';

    currentUser = { email, name, company, subscription };
    document.getElementById('user-display').textContent = name || 'User';
    document.getElementById('settings-email').textContent = email;
    document.getElementById('settings-name').textContent = name;
    document.getElementById('settings-company').textContent = company;
    document.getElementById('settings-sub').textContent = subscription.toUpperCase();
  }

  async function loadDashboardData() {
    try {
      const userId = currentUser.email;

      // Load user document from Firestore
      const userDoc = await db.collection('users').docserId).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        
        // Calculate totals
        const totalRevenue = userData.totalRevenue || 0;
        const invoices = userData.invoices || [];
        const pendingCount = invoices.filter(inv => inv.status === 'pending').length;
        
        document.getElementById('total-revenue').textContent = '$' + totalRevenue.toLocaleString();
        document.getElementById('pending-invoices').textContent = pendingCount;
        document.getElementById('total-contacts').textContent = (userData.contacts || []).length;
        document.getElementById('total-expenses').textContent = '$' + (userData.totalExpenses || 0).toLocaleString();

        // Load recent activity
        loadRecentActivity(invoices);
      } else {
        setPlaceholderData();
      }

      // Load AI Insights
      await loadAIInsights();
    } catch (error) {
      console.error('Error loading dashboard:', error);
      setPlaceholderData();
    }
  }

  function setPlaceholderData() {
    document.getElementById('total-revenue').textContent = '$12,500';
    document.getElementById('pending-invoices').textContent = '3';
    document.getElementById('total-contacts').textContent = '24';
    document.getElementById('total-expenses').textContent = '$3,200';
    
    document.getElementById('recent-activity').innerHTML = `
      <div class="list-item">
        <div>
          <strong>Invoice INV-001 Created</strong><br>
          <span style="color: #888; font-size: 0.9rem;">Today â€¢ $500.00</span>
        </div>
        <span class="status-badge status-paid">Sent</span>
      </div>
      <div class="list-item">
        <div>
          <strong>New Contact Added</strong><br>
          <span style="color: #888; font-size: 0.9rem;">Yesterday â€¢ John Doe</span>
        </div>
        <span class="status-badge status-pending">Active</span>
      </div>
    `;
  }

  function loadRecentActivity(invoices) {
    const recent = invoices.slice(0, 3);
    let html = '';
    
    if (recent.length === 0) {
      html = '<div style="color: #888; text-align: center; padding: 2rem;"><i class="fas fa-inbox"></i> No recent activity</div>';
    } else {
      recent.forEach(inv => {
        const status = inv.status || 'pending';
        const badgeClass = status === 'paid' ? 'status-paid' : status === 'overdue' ? 'status-overdue' : 'status-pending';
        html += `
          <div class="list-item">
            <div>
              <strong>${inv.number || 'Invoice'}</strong><br>
              <span style="color: #888; font-size: 0.9rem;">$${(inv.amount || 0).toLocaleString()}</span>
            </div>
            <span class="status-badge ${badgeClass}">${status.toUpperCase()}</span>
          </div>
        `;
      });
    }
    
    document.getElementById('recent-activity').innerHTML = html;
  }

  async function loadAIInsights() {
    try {
      const callAIAssistant = functions.httpsCallable('aiAssistant');
      const result = await callAIAssistant({
        userId: currentUser.email,
        context: 'business_health',
        maxTokens: 300
      });

      const insights = result.data?.response || 'Your business is performing well. Keep track of your invoices and maintain regular client contact for best results.';
      document.getElementById('ai-insights-card').innerHTML = insights;
      document.getElementById('ai-health').innerHTML = insights;
      document.getElementById('ai-actions').innerHTML = 'âœ“ Follow up with pending invoices<br>âœ“ Review monthly expenses<br>âœ“ Sient meetings';
    } catch (error) {
      console.log('AI service not available:', error);
      document.getElementById('ai-insights-card').innerHTML = 'ðŸ’¡ AI insights will appear here once your business data is synced.';
    }
  }

  function switchSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.target.closest('.nav-item')?.classList.add('active');
    
    // Update header
    const titles = {
      'dashboard': 'Dashboard',
      'contacts': 'Contacts',
      'invoices': 'Invoices',
      'expenses': 'Expenses',
      'inventory': 'Inventory',
      'tasks': 'Tasks',
      'ai-insights': 'AI Intelligence',
      'settings': 'Settings'
    };
    document.getElementById('current-page').textContent = titles[sectionId] || 'Dashboard';
  }

  // Modal functions
  function openAddContactModal() { openModal('add-contact-modal'); }
  function openAddInvoiceModal() { openModal('add-invoice-modal'); }
  function openAddExpenseModal() { alert('Expense tracking coming soon'); }
  function openAddInventoryModal() { alert('Inventory management coming soon'); }
  function openAddTaskModal() { alert('Task management coming soon'); }
  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }

  async function saveContact() {
    const name = document.getElementById('contact-name').value.trim();
    const email = document.getElementById('contact-email').value.trim();
    const phone = document.getElementById('contact-phone').value.trim();
    const company = document.getElementById('contact-company').value.trim();

    if (!name || !email) {
      alert('Name and email are required');
      return;
    }

    try {
      await db.collection('users').doc(currentUser.email).collection('contacts').add({
        name, email, phone, company,
        createdAt: new Date(),
        status: 'active'
      });

      alert('Contact saved successfully!');
      closeModal('add-contact-modal');
      document.getElementById('contact-name').value = '';
      document.getElementById('contact-email').value = '';
      document.getElementById('contact-phone').value = '';
      document.getElementById('contact-company').value = '';
    } catch (error) {
      alert('Error saving contact: ' + error.message);
    }
  }

  async function saveInvoice() {
    const contactEmail = document.getElementById('invoice-contact-email').value.trim();
    const amount = parseFloat(document.getElementById('invoice-amount').value);
    const description = document.getElementById('invoice-description').value.trim();
    const dueDate = document.getElementById('invoice-due-date').value;

    if (!contactEmail || !amount) {
      alert('Contact email and amount are required');
      return;
    }

    try {
      const generateInvoiceNumber = functions.httpsCallable('generateInvoiceNumber');
      const { data: { invoiceNumber } } = await generateInvoiceNumber({
        userId: currentUser.email
      });

      await db.collection('users').doc(currentUser.email).collection('invoices').add({
        number: invoiceNumber,
        contactEmail,
        amount,
        description,
        dueDate: dueDate ? new Date(dueDate) : null,
        status: 'pending',
        createdAt: new Date(),
        paidAt: null
      ;

      alert('Invoice created: ' + invoiceNumber);
      closeModal('add-invoice-modal');
      document.getElementById('invoice-contact-email').value = '';
      document.getElementById('invoice-amount').value = '';
      document.getElementById('invoice-description').value = '';
      document.getElementById('invoice-due-date').value = '';
    } catch (error) {
      alert('Error creating invoice: ' + error.message);
    }
  }

  async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML += `<div class="chat-message message-user">${message}</div>`;
    input.value = '';

    try {
      const callAIAssistant = functions.httpsCallable('aiAssistant');
      const result = await callAIAssistant({
        userId: currentUser.email,
        prompt: message,
        maxTokens: 200
      });

      const aiResponse = result.data?.response || 'I understand. Please provide more details.';
      messagesDiv.innerHTML += `<div class="chat-message message-ai">${aiResponse}</div>`;
    } catch (error) {
      messagesDiv.innerHTML += `<div class="chat-message message-ai">Sorry, I'm having trouble processing that. Please try again.</div>`;
    }
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function handleChatKeypress(event) {
    if (event.key === 'Enter') sendChatMessage();
  }

  function closeAIChat() {
    document.getElementById('ai-chat-widget').style.display = 'none';
  }

  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      localStorage.clear();
      window.location.href = '/crm-login.html';
    }
  }
</script>

</body>
</html>
