rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // user devices
    match /users/{uid}/devices/{deviceId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid;
      allow update: if request.auth != null && request.auth.uid == uid;
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // user notifications - readable by owner
    match /users/{uid}/notifications/{notifId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      // Clients should not create notifications - only server (admin) may
      allow create: if false;
      allow update: if request.auth != null && request.auth.uid == uid && request.resource.data.keys().hasOnly(['read']);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // notification audit (server writes only)
    match /notifications_audit/{doc} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow write: if false;
    }

    // analytics & other server-only collections should be blocked for client writes
    match /analytics/{document=**} {
      allow read: if request.auth != null && (request.auth.token.admin == true || request.auth.token.auraRole == 'analyst');
      allow write: if false;
    }

    // fallback - restrict everything else as usual
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
