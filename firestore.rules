rules_version = '2';
service cloud.firestore {
  function isAdmin() {
    return request.auth != null && request.auth.token.admin == true;
  }

  match /databases/{database}/documents {
    // user devices
    match /users/{uid}/devices/{deviceId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid;
      allow update: if request.auth != null && request.auth.uid == uid;
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // user notifications - readable by owner
    match /users/{uid}/notifications/{notifId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      // Clients should not create notifications - only server (admin) may
      allow create: if false;
      allow update: if request.auth != null && request.auth.uid == uid && request.resource.data.keys().hasOnly(['read']);
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // user notification preferences - read/write by owner
    match /users/{uid}/settings/notification_preferences {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // user timezone & locale - read/write by owner
    match /users/{uid}/settings/timezone {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // notification audit (server writes only, users read their own, admins read all)
    match /notifications_audit/{docId} {
      allow read: if request.auth != null && (resource.data.targetUid == request.auth.uid || isAdmin());
      allow write: if false;
    }

    // analytics & other server-only collections should be blocked for client writes
    match /analytics/{document=**} {
      allow read: if request.auth != null && (request.auth.token.admin == true || request.auth.token.auraRole == 'analyst');
      allow write: if false;
    }

    // AuraToken wallet - users can read their own balance, server writes only
    match /users/{userId}/wallet/aura {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Server-only via Cloud Functions
    }

    // Token audit log - users can read their own transactions, immutable
    match /users/{userId}/token_audit/{auditId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update, delete: if false;
    }

    // Processed payment sessions - webhook only, no client access
    match /payments_processed/{sessionId} {
      allow read, write: if false; // Written only by webhook function
    }

    // fallback - restrict everything else as usual
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
