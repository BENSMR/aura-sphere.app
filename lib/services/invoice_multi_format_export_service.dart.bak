import 'dart:typed_data';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:cloud_functions/cloud_functions.dart';
import '../data/models/invoice_model.dart';
import '../core/utils/logger.dart';

/// Service for exporting invoices in multiple formats using Cloud Function
class InvoiceMultiFormatExportService {
  final _functions = FirebaseFunctions.instance;
  final _storage = FirebaseStorage.instance;

  /// Export invoice in all formats (PDF, PNG, DOCX, CSV, ZIP)
  /// 
  /// Parameters:
  /// - invoice: InvoiceModel (required)
  /// - businessName: String
  /// - businessAddress: String
  /// - userLogoUrl: String (optional)
  /// - notes: String (optional)
  /// 
  /// Returns: {
  ///   success: bool,
  ///   urls: {
  ///     'pdf': string,
  ///     'png': string,
  ///     'docx': string,
  ///     'csv': string,
  ///     'zip': string
  ///   },
  ///   metadata: { ... }
  /// }
  Future<Map<String, dynamic>> exportAllFormats({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      logger.info('Exporting invoice in all formats', {
        'invoiceNumber': invoice.invoiceNumber,
      });

      // Prepare items in the format expected by Cloud Function
      final items = invoice.items
          .map((item) => {
                'description': item.description,
                'quantity': item.quantity,
                'unitPrice': item.unitPrice,
                'total': item.total,
              })
          .toList();

      // Call Cloud Function
      final result = await _functions.httpsCallable('exportInvoiceFormats').call({
        'invoiceNumber': invoice.invoiceNumber,
        'createdAt': invoice.createdAt.toDate().toIso8601String(),
        'dueDate': invoice.dueDate?.toIso8601String() ?? DateTime.now().toIso8601String(),
        'items': items,
        'currency': invoice.currency,
        'subtotal': invoice.subtotal,
        'tax': invoice.tax,
        'discount': invoice.discount,
        'total': invoice.total,
        'businessName': businessName,
        'businessAddress': businessAddress,
        'clientName': invoice.clientName,
        'clientEmail': invoice.clientEmail,
        'userLogoUrl': userLogoUrl,
        'notes': notes,
      });

      logger.info('Export all formats - success', {
        'invoiceNumber': invoice.invoiceNumber,
        'formats': (result.data['metadata']['formats'] as List).length,
      });

      return result.data;
    } catch (e) {
      logger.error('Export all formats - failed', {
        'invoiceNumber': invoice.invoiceNumber,
        'error': e.toString(),
      });
      rethrow;
    }
  }

  /// Export invoice as PDF only
  Future<String> exportPdf({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      return result['urls']['${invoice.invoiceNumber}.pdf'];
    } catch (e) {
      logger.error('Export PDF - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Export invoice as DOCX only
  Future<String> exportDocx({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      return result['urls']['${invoice.invoiceNumber}.docx'];
    } catch (e) {
      logger.error('Export DOCX - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Export invoice as CSV only
  Future<String> exportCsv({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      return result['urls']['${invoice.invoiceNumber}.csv'];
    } catch (e) {
      logger.error('Export CSV - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Export invoice as PNG only
  Future<String> exportPng({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      return result['urls']['${invoice.invoiceNumber}.png'];
    } catch (e) {
      logger.error('Export PNG - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Export all formats as ZIP
  Future<String> exportZip({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      return result['urls']['${invoice.invoiceNumber}.zip'];
    } catch (e) {
      logger.error('Export ZIP - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Get all export URLs for an invoice
  Future<Map<String, String>> getExportUrls({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      final urls = result['urls'] as Map<String, dynamic>;
      return urls.cast<String, String>();
    } catch (e) {
      logger.error('Get export URLs - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Download file from signed URL
  Future<Uint8List> downloadFile(String url) async {
    try {
      final response = await _storage.refFromURL(url).getBytes();
      return response;
    } catch (e) {
      logger.error('Download file - failed', {'error': e.toString()});
      rethrow;
    }
  }

  /// Get metadata about export
  Future<Map<String, dynamic>> getExportMetadata({
    required InvoiceModel invoice,
    required String businessName,
    required String businessAddress,
    String? userLogoUrl,
    String? notes,
  }) async {
    try {
      final result = await exportAllFormats(
        invoice: invoice,
        businessName: businessName,
        businessAddress: businessAddress,
        userLogoUrl: userLogoUrl,
        notes: notes,
      );

      return result['metadata'] as Map<String, dynamic>;
    } catch (e) {
      logger.error('Get export metadata - failed', {'error': e.toString()});
      rethrow;
    }
  }
}
