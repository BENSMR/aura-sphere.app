import 'package:pdf/widgets.dart' as pw;
import 'package:pdf/pdf.dart';
import 'package:intl/intl.dart';
import '../../data/models/invoice_model.dart';

/// Modern template - contemporary design with enhanced branding
/// Features: gradient-like colors, modern spacing, icons
class InvoiceTemplateModern {
  /// Build modern invoice PDF page
  static List<pw.Widget> build(
    pw.Context context,
    InvoiceModel invoice,
    Map<String, dynamic> business,
    PdfColor brandColor,
  ) {
    final currency = invoice.currency.toUpperCase();
    final df = DateFormat.yMMMd();
    final accentColor = brandColor.withOpacity(0.3);

    return [
      // Header background section
      pw.Container(
        padding: const pw.EdgeInsets.all(20),
        decoration: pw.BoxDecoration(
          color: accentColor,
          borderRadius: const pw.BorderRadius.all(pw.Radius.circular(8)),
        ),
        child: pw.Row(
          mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
          children: [
            pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  business['businessName'] ?? 'Business Name',
                  style: pw.TextStyle(
                    fontSize: 24,
                    fontWeight: pw.FontWeight.bold,
                    color: brandColor,
                  ),
                ),
                pw.SizedBox(height: 4),
                if (business['tagline'] != null)
                  pw.Text(
                    business['tagline'] as String,
                    style: pw.TextStyle(
                      fontSize: 11,
                      color: PdfColors.grey700,
                      fontStyle: pw.FontStyle.italic,
                    ),
                  ),
              ],
            ),
            pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.end,
              children: [
                pw.Text(
                  'INVOICE',
                  style: pw.TextStyle(
                    fontSize: 32,
                    fontWeight: pw.FontWeight.bold,
                    color: brandColor,
                  ),
                ),
                pw.SizedBox(height: 4),
                pw.Container(
                  padding: const pw.EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 6,
                  ),
                  decoration: pw.BoxDecoration(
                    color: brandColor,
                    borderRadius: const pw.BorderRadius.all(pw.Radius.circular(4)),
                  ),
                  child: pw.Text(
                    invoice.invoiceNumber ?? 'N/A',
                    style: const pw.TextStyle(
                      fontSize: 12,
                      color: PdfColors.white,
                      fontWeight: pw.FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
      pw.SizedBox(height: 24),

      // Two-column layout: dates and client
      pw.Row(
        mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
        children: [
          // Left column - dates
          pw.Column(
            crossAxisAlignment: pw.CrossAxisAlignment.start,
            children: [
              pw.Text(
                'Invoice Details',
                style: pw.TextStyle(
                  fontSize: 12,
                  fontWeight: pw.FontWeight.bold,
                  color: brandColor,
                ),
              ),
              pw.SizedBox(height: 12),
              _dateField('Date', df.format(invoice.createdAt.toDate())),
              pw.SizedBox(height: 8),
              if (invoice.dueDate != null)
                _dateField('Due Date', df.format(invoice.dueDate!)),
              pw.SizedBox(height: 8),
              _dateField('Currency', currency),
            ],
          ),
          // Right column - client
          pw.Column(
            crossAxisAlignment: pw.CrossAxisAlignment.start,
            children: [
              pw.Text(
                'Bill To',
                style: pw.TextStyle(
                  fontSize: 12,
                  fontWeight: pw.FontWeight.bold,
                  color: brandColor,
                ),
              ),
              pw.SizedBox(height: 12),
              pw.Container(
                padding: const pw.EdgeInsets.all(12),
                decoration: pw.BoxDecoration(
                  border: pw.Border(
                    left: pw.BorderSide(color: brandColor, width: 3),
                  ),
                ),
                child: pw.Column(
                  crossAxisAlignment: pw.CrossAxisAlignment.start,
                  children: [
                    pw.Text(
                      invoice.clientName,
                      style: pw.TextStyle(
                        fontSize: 12,
                        fontWeight: pw.FontWeight.bold,
                      ),
                    ),
                    pw.SizedBox(height: 4),
                    pw.Text(
                      invoice.clientEmail,
                      style: const pw.TextStyle(fontSize: 10),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
      pw.SizedBox(height: 28),

      // Items table - modern style
      pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Text(
            'Line Items',
            style: pw.TextStyle(
              fontSize: 12,
              fontWeight: pw.FontWeight.bold,
              color: brandColor,
            ),
          ),
          pw.SizedBox(height: 12),
          pw.Table(
            border: pw.TableBorder(
              horizontalInside: pw.BorderSide(
                color: PdfColors.grey300,
                width: 0.5,
              ),
              bottom: pw.BorderSide(color: brandColor, width: 2),
              top: pw.BorderSide(color: brandColor, width: 2),
            ),
            columnWidths: {
              0: const pw.FlexColumnWidth(3),
              1: const pw.FlexColumnWidth(0.8),
              2: const pw.FlexColumnWidth(1.2),
              3: const pw.FlexColumnWidth(1),
            },
            children: [
              // Header row
              pw.TableRow(
                children: [
                  pw.Padding(
                    padding: const pw.EdgeInsets.symmetric(vertical: 10),
                    child: pw.Text(
                      'Description',
                      style: pw.TextStyle(
                        fontWeight: pw.FontWeight.bold,
                        fontSize: 11,
                        color: brandColor,
                      ),
                    ),
                  ),
                  pw.Padding(
                    padding: const pw.EdgeInsets.symmetric(vertical: 10),
                    child: pw.Text(
                      'Qty',
                      style: pw.TextStyle(
                        fontWeight: pw.FontWeight.bold,
                        fontSize: 11,
                        color: brandColor,
                      ),
                      textAlign: pw.TextAlign.center,
                    ),
                  ),
                  pw.Padding(
                    padding: const pw.EdgeInsets.symmetric(vertical: 10),
                    child: pw.Text(
                      'Unit Price',
                      style: pw.TextStyle(
                        fontWeight: pw.FontWeight.bold,
                        fontSize: 11,
                        color: brandColor,
                      ),
                      textAlign: pw.TextAlign.right,
                    ),
                  ),
                  pw.Padding(
                    padding: const pw.EdgeInsets.symmetric(vertical: 10),
                    child: pw.Text(
                      'Total',
                      style: pw.TextStyle(
                        fontWeight: pw.FontWeight.bold,
                        fontSize: 11,
                        color: brandColor,
                      ),
                      textAlign: pw.TextAlign.right,
                    ),
                  ),
                ],
              ),
              // Item rows
              ...invoice.items.map((item) {
                return pw.TableRow(
                  children: [
                    pw.Padding(
                      padding: const pw.EdgeInsets.symmetric(vertical: 8),
                      child: pw.Text(item.description, fontSize: 11),
                    ),
                    pw.Padding(
                      padding: const pw.EdgeInsets.symmetric(vertical: 8),
                      child: pw.Text(
                        item.quantity.toString(),
                        textAlign: pw.TextAlign.center,
                        fontSize: 11,
                      ),
                    ),
                    pw.Padding(
                      padding: const pw.EdgeInsets.symmetric(vertical: 8),
                      child: pw.Text(
                        '${item.unitPrice.toStringAsFixed(2)}',
                        textAlign: pw.TextAlign.right,
                        fontSize: 11,
                      ),
                    ),
                    pw.Padding(
                      padding: const pw.EdgeInsets.symmetric(vertical: 8),
                      child: pw.Text(
                        '${item.total.toStringAsFixed(2)}',
                        textAlign: pw.TextAlign.right,
                        fontSize: 11,
                      ),
                    ),
                  ],
                );
              }),
            ],
          ),
        ],
      ),
      pw.SizedBox(height: 24),

      // Summary section - modern style
      pw.Row(
        mainAxisAlignment: pw.MainAxisAlignment.end,
        children: [
          pw.Container(
            width: 250,
            padding: const pw.EdgeInsets.all(16),
            decoration: pw.BoxDecoration(
              color: accentColor,
              borderRadius: const pw.BorderRadius.all(pw.Radius.circular(8)),
              border: pw.Border.all(color: brandColor, width: 1),
            ),
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.end,
              children: [
                _summaryRow('Subtotal:', '${invoice.subtotal.toStringAsFixed(2)} $currency'),
                pw.SizedBox(height: 6),
                if (invoice.taxRate > 0)
                  _summaryRow(
                    'Tax (${(invoice.taxRate * 100).toStringAsFixed(0)}%):',
                    '${invoice.tax.toStringAsFixed(2)} $currency',
                  ),
                if (invoice.taxRate > 0) pw.SizedBox(height: 6),
                if (invoice.discount > 0)
                  _summaryRow(
                    'Discount:',
                    '-${invoice.discount.toStringAsFixed(2)} $currency',
                  ),
                if (invoice.discount > 0) pw.SizedBox(height: 6),
                pw.Divider(color: brandColor, thickness: 1),
                pw.SizedBox(height: 8),
                pw.Row(
                  mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
                  children: [
                    pw.Text(
                      'TOTAL',
                      style: pw.TextStyle(
                        fontSize: 14,
                        fontWeight: pw.FontWeight.bold,
                        color: brandColor,
                      ),
                    ),
                    pw.Text(
                      '${invoice.total.toStringAsFixed(2)} $currency',
                      style: pw.TextStyle(
                        fontSize: 14,
                        fontWeight: pw.FontWeight.bold,
                        color: brandColor,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
      pw.SizedBox(height: 20),

      // Payment status
      if (invoice.isPaid)
        pw.Container(
          padding: const pw.EdgeInsets.all(12),
          decoration: pw.BoxDecoration(
            color: PdfColors.green.withOpacity(0.15),
            border: pw.Border.all(color: PdfColors.green, width: 2),
            borderRadius: const pw.BorderRadius.all(pw.Radius.circular(6)),
          ),
          child: pw.Text(
            'âœ“ PAID',
            style: pw.TextStyle(
              color: PdfColors.green,
              fontSize: 14,
              fontWeight: pw.FontWeight.bold,
            ),
          ),
        ),
    ];
  }

  /// Helper: render date field
  static pw.Widget _dateField(String label, String value) {
    return pw.Column(
      crossAxisAlignment: pw.CrossAxisAlignment.start,
      children: [
        pw.Text(
          label,
          style: const pw.TextStyle(fontSize: 9, color: PdfColors.grey700),
        ),
        pw.SizedBox(height: 2),
        pw.Text(
          value,
          style: pw.TextStyle(
            fontSize: 11,
            fontWeight: pw.FontWeight.bold,
          ),
        ),
      ],
    );
  }

  /// Helper: render summary row
  static pw.Widget _summaryRow(String label, String value) {
    return pw.Row(
      mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
      children: [
        pw.Text(label, fontSize: 10),
        pw.Text(value, fontSize: 10, fontWeight: pw.FontWeight.bold),
      ],
    );
  }
}
