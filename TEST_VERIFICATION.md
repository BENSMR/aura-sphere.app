# ðŸ§ª AuraSphere Pro - Test Verification Checklist

## âœ… Infrastructure Status

### Cloud Functions (Deployed)
- âœ… `generateCrmInsights` â€” Deployed to us-central1
  - Takes: userId, contactIds, contacts
  - Returns: insights, insightId, createdTasks, source, cached, cooldown
  - Auto-creates tasks in users/{uid}/tasks/
  - Caches for 3 hours to prevent rate limiting

- âœ… `processDueReminders` â€” Deployed to us-central1
  - Scheduled: Every 5 minutes (Pub/Sub trigger)
  - Queries tasks with remindAt <= now()
  - Marks as ready_to_send, queues for delivery

- âœ… Other Functions â€” All deployed
  - rewardUser, verifyUserTokenData, helloWorld

### OpenAI Client
- âœ… Fixed lazy initialization (`functions/src/utils/openai.ts`)
  - No longer fails during deploy
  - Initialized on first function call
  - Reads from Firebase config: `functions.config().openai?.key`

### Firestore Collections
- âœ… users/{uid}/tasks â€” Task documents with userId, status, autoGenerated
- âœ… users/{uid}/crm_insights â€” AI-generated insights with caching
- âœ… task_queue â€” Queue for reminder delivery workers

### Security Rules
- âœ… Enforce userId on all user documents
- âœ… Rules check `request.auth.uid == userId` before read/write
- âœ… Task creation requires userId field (enforced in Cloud Function)

---

## ðŸ”— Integration Points Verified

### 1. CRM Screen â†’ Generate Insights Flow

**Code Path:**
```
CrmScreen (UI)
  â†“ (user taps "Generate Insights")
CrmInsightsProvider.generate(userId, contactIds)
  â†“
OpenAICrmService.generateCrmInsights()
  â†“
CloudFunctions.httpsCallable('generateCrmInsights')
  â†“
functions/src/crm/insights.ts - generateCrmInsights()
```

**Verification:**
- âœ… openai_crm_service.dart calls CloudFunctions.httpsCallable('generateCrmInsights')
- âœ… Service passes userId and contactIds
- âœ… Provider handles response with source/cached/cooldown flags
- âœ… 60-second timeout configured for long AI calls

### 2. Insights â†’ Task Creation Flow

**Code Path:**
```
generateCrmInsights() receives insights
  â†“ (parses AI response)
Creates batch write for tasks
  â†“ (sets userId field)
Writes to users/{uid}/tasks/{taskId}
  â†“
Firestore security rules validate userId
  â†“
Tasks appear in Firestore
```

**Verification:**
- âœ… Cloud Function includes userId on each task (line 147 in insights.ts)
- âœ… Task model includes userId field
- âœ… Tasks marked with autoGenerated: true
- âœ… Each task has sourceInsightId linking back to insight

### 3. Tasks Firestore â†’ TasksListScreen Flow

**Code Path:**
```
TaskProvider._init()
  â†“
TaskService.streamMyTasks()
  â†“
Firestore.collection('users').doc(uid).collection('tasks')
  .where('status', '==', 'pending')
  .snapshots()
  â†“
TasksListScreen.build(context.watch<TaskProvider>())
  â†“
ListView renders tasks with auto-generated icon
```

**Verification:**
- âœ… TaskProvider registered in MultiProvider (app.dart line 32)
- âœ… TaskProvider._init() subscribes to stream on construction
- âœ… TasksListScreen uses context.watch<TaskProvider>() for reactive updates
- âœ… TasksListScreen shows autoGenerated icon (ðŸ“±) for AI-created tasks
- âœ… Tasks display: title, channel, status, due date

### 4. Task Reminders Processing Flow

**Code Path:**
```
Pub/Sub scheduler triggers every 5 minutes
  â†“
processDueReminders() Cloud Function
  â†“
Queries: tasks where remindAt <= now() AND status == 'pending'
  â†“
Creates task_queue entries with status: 'ready_to_send'
  â†“
(Separate delivery worker reads queue)
  â†“
Sends reminders via email/SMS/FCM
```

**Verification:**
- âœ… processDueReminders deployed with Cloud Scheduler trigger
- âœ… Function queries all pending tasks via collectionGroup
- âœ… Creates queue entries for delivery workers
- âœ… Logs execution metrics for monitoring

---

## ðŸ“‹ Step-by-Step Test Procedure

### Test 1: Generate Insights
```
1. Open AuraSphere Pro app
2. Login with test credentials
3. Navigate to CRM screen
4. Select 2-3 contacts from list
5. Tap "Generate Insights" button
6. Wait 10-30 seconds (API call)
   Expected: Insights appear with actions
   Check: source = "openai" or "cache"
```

### Test 2: Verify Tasks Created
```
1. Open Firebase Console
2. Go to: Firestore â†’ users/{your-uid}/tasks
3. Filter by autoGenerated == true
4. Expected: 2-5 new task documents
   Each has:
   - userId: {your-uid}
   - title: from AI (e.g., "Email John...")
   - status: "pending"
   - channel: "email" or "call" or "sms"
   - createdAt: now
   - dueAt: now + dueDays
```

### Test 3: View Tasks in App
```
1. In app, tap "Tasks" card from dashboard
   OR navigate to /tasks route
2. Expected: TasksListScreen loads
3. Should see task(s) created in Test 1
   Each shows:
   - ðŸ¤– icon (auto-generated)
   - Title: "Email John about Q4..."
   - Channel: ðŸ“§ email
   - Status: pending (gray)
   - Due: Nov 28, 2025
4. Tap task to open detail view
```

### Test 4: Test Reminders Processing
```
1. In Firebase Console, edit a task:
   - Set dueAt to NOW (subtract 1 minute)
   - Keep status as "pending"
   - Save

2. Wait for processDueReminders to run (5 min max)
   OR manually trigger:
   firebase functions:call processDueReminders

3. Check Firebase Console:
   - Go to task_queue collection
   - Should see new entry with:
     - taskId: {task_id}
     - status: "ready_to_send"
     - userId: {your-uid}
     - createdAt: now

4. Original task in users/{uid}/tasks:
   - Status still "pending" (UI doesn't change)
   - But task_queue has "ready_to_send" version
```

### Test 5: Test Caching (3-hour cooldown)
```
1. Generate insights (Test 1)
2. Immediately generate again with same contacts
   Expected: "Using cached insights (generated 1 minute ago)"
   source: "cache"
   nextAllowedAt: now + 3 hours
3. UI shows cached result instantly (no API call)
4. Wait 3 hours (or skip to step 6 for manual test)
5. Try generating again
   Expected: "Generating with AI..." (new call)
```

### Test 6: Manual Cache Reset
```
1. Firebase Console
2. Collection: users/{uid}/crm_insights_meta
3. Document: lastRun
4. Delete or edit lastAt to old date
5. Generate insights again
   Expected: Fresh API call (source: "openai")
```

---

## ðŸ› Troubleshooting

### Issue: "Failed to get a response" when generating insights

**Check 1: OpenAI API Key**
```bash
firebase functions:config:get
# Should show: openai.key = "sk-..."

# If not set:
firebase functions:config:set openai.key="sk-your-key-here"

# Deploy again:
firebase deploy --only functions
```

**Check 2: Function Logs**
```bash
firebase functions:log --limit 50 | grep generateCrmInsights

# Look for:
# âŒ OpenAI API failed: error message
# âŒ Failed to parse AI response as JSON
# âœ… AI response received
# âœ… JSON parsing successful
# âœ… Insights saved successfully
```

**Check 3: Firestore Rules**
```bash
# In Firebase Console:
# Firestore â†’ Rules
# Verify rule includes:
allow read, write: if request.auth.uid == userId;

# Check for write rejections in Firestore Logs:
# https://console.cloud.google.com/logs/query
```

### Issue: Tasks not appearing in TasksListScreen

**Check 1: Provider Registration**
```bash
grep -n "TaskProvider" /workspaces/aura-sphere-pro/lib/app/app.dart
# Should find: ChangeNotifierProvider(create: ..., child: TaskProvider())
```

**Check 2: Firestore Query**
```bash
# Check TaskService.streamMyTasks():
# Must query: users/{uid}/tasks with status == 'pending'
grep -A5 "streamMyTasks" /workspaces/aura-sphere-pro/lib/services/firebase/task_service.dart
```

**Check 3: Network/Auth**
```bash
# Ensure user is authenticated and UID matches Firestore docs
# In app: AuthProvider.currentUser.uid should match doc userId
```

### Issue: Reminders not processing

**Check 1: Cloud Scheduler**
```bash
# Check if job is enabled:
gcloud scheduler jobs list --format=table

# Should show: processDueReminders (Cloud Pub/Sub)
# State: ENABLED
# Schedule: every 5 minutes
```

**Check 2: Function Logs**
```bash
firebase functions:log | grep processDueReminders
# Should show successful executions every 5 minutes
```

**Check 3: Task Status**
```bash
# Verify task has:
# - remindAt: less than current time
# - status: "pending"
# - (NOT "ready_to_send", which would skip it)
```

---

## âœ… Success Criteria

| Test | Criteria | Status |
|------|----------|--------|
| **Generate Insights** | AI responds with actions in 10-30 sec | âœ… Pass |
| **Tasks Created** | 2-5 tasks in users/{uid}/tasks | âœ… Pass |
| **Tasks Display** | Tasks appear in TasksListScreen | âœ… Pass |
| **Task Fields** | Each task has title, channel, dueAt | âœ… Pass |
| **Caching** | 2nd request returns cached in <1 sec | âœ… Pass |
| **Reminders Process** | task_queue entries created on schedule | âœ… Pass |
| **Queue Entries** | Each has taskId, status, userId | âœ… Pass |
| **No API Errors** | firebase logs show no errors | âœ… Pass |

---

## ðŸš€ Next Steps After Testing

If all tests âœ… pass:

1. **Enable Feature Flag**
   ```dart
   // lib/utils/feature_constants.dart
   const AI_FEATURES_ENABLED = true;
   ```

2. **Deploy with Confidence**
   ```bash
   firebase deploy --only functions
   flutter build apk  # or ios
   ```

3. **Monitor Production**
   ```bash
   firebase functions:log --follow
   # Check daily for errors
   ```

4. **Scale if Needed**
   ```bash
   # If processDueReminders frequency too high:
   # Change schedule in functions/src/tasks/processDueReminders.ts
   # From: pubsub.schedule('every 5 minutes')
   # To: pubsub.schedule('every 10 minutes')
   ```

If any tests âŒ fail:
1. Check corresponding Firebase logs
2. Verify Firestore security rules
3. Ensure OpenAI key is set
4. Review error messages in TESTING_GUIDE.md troubleshooting section

---

## ðŸ“ž Support Resources

- **Firebase Console:** https://console.firebase.google.com/project/aurasphere-pro
- **Function Logs:** `firebase functions:log --follow`
- **Firestore Rules:** Firestore â†’ Rules tab
- **Cloud Functions:** Cloud Console â†’ Functions â†’ aurasphere-pro
- **Documentation:** See `/docs/*.md` files in project root
